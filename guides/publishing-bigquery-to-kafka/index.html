<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.3">
<title data-react-helmet="true">Publishing from bigQuery to kafka | Optimus</title><meta data-react-helmet="true" property="og:url" content="https://odpf.github.io/optimus/guides/publishing-bigquery-to-kafka/"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Publishing from bigQuery to kafka | Optimus"><meta data-react-helmet="true" name="description" content="Following are the steps to publish BQ data to Kafka:"><meta data-react-helmet="true" property="og:description" content="Following are the steps to publish BQ data to Kafka:"><link data-react-helmet="true" rel="shortcut icon" href="/optimus/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://odpf.github.io/optimus/guides/publishing-bigquery-to-kafka/"><link data-react-helmet="true" rel="alternate" href="https://odpf.github.io/optimus/guides/publishing-bigquery-to-kafka/" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://odpf.github.io/optimus/guides/publishing-bigquery-to-kafka/" hreflang="x-default"><link rel="stylesheet" href="/optimus/assets/css/styles.42d826e0.css">
<link rel="preload" href="/optimus/assets/js/runtime~main.310a3fda.js" as="script">
<link rel="preload" href="/optimus/assets/js/main.7ea66b74.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/optimus/"><img src="/optimus/img/logo.svg" alt="Optimus Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/optimus/img/logo.svg" alt="Optimus Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">Optimus</b></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/odpf/optimus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle displayOnlyInLargeViewport_GrZ2 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/optimus/"><img src="/optimus/img/logo.svg" alt="Optimus Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/optimus/img/logo.svg" alt="Optimus Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">Optimus</b></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a href="https://github.com/odpf/optimus" target="_blank" rel="noopener noreferrer" class="menu__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_31aa"><main class="docMainContainer_3ufF docMainContainerEnhanced_3NYZ"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="markdown"><header><h1 class="h1Heading_27L5">Publishing from bigQuery to kafka</h1></header><p>Following are the steps to publish BQ data to Kafka:</p><ol><li>Raise a ticket with DE to create the proto, soon this will be automated.</li><li>As part of Job Specification answer the questions related to pushing data to Kafka.</li><li>Commit and Push</li></ol><p>Publishing from Bigquery to Kafka is done using an Optimus hook called <code>Transporter</code>.
Once data is pushed to Kafka you can use firehose to consume messages for your needs.
In order to add hook to an existing Job, run the following command and answer the
corresponding prompts:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">$ ./optimus create hook</span></span><span class="token-line" style="color:#393A34"><span class="token plain">? Select a Job example_job</span></span><span class="token-line" style="color:#393A34"><span class="token plain">? Which hook to run? transporter</span></span><span class="token-line" style="color:#393A34"><span class="token plain">? Filter expression for extracting transformation rows? event_timestamp &gt;= &#x27;{{.DSTART}}&#x27; AND event_timestamp &lt; &#x27;{{.DEND}}&#x27;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Note: this is not available for public use at the moment</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="config"></a>Config:<a class="hash-link" href="#config" title="Direct link to heading">#</a></h3><ul><li>Filter expression: Expression is used as a where clause to restrict the number of rows to only push the ones
that are affected by current transformation. Expression can be templated with DSTART and DEND macros which will be replaced with the window for which the current transformation is getting executed similar to what we do in Job specifications.</li></ul><p>After this, existing job.yaml file will get updated with the new hooks config and the job specification would look like below:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> example_job</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">owner</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> example@example.com</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">schedule</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">start_date</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;2021-02-18&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">interval</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 0 3 * * *</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">behavior</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">depends_on_past</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">false</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">catch_up</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">task</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> bq2bq</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">DATASET</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">LOAD_METHOD</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> APPEND</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">PROJECT</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> example</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">SQL_TYPE</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> STANDARD</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">TABLE</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> hello_table</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">window</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">size</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 24h</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">offset</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;0&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">truncate_to</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> d</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">dependencies</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">hooks</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> transporter</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">BQ_DATASET</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;{{.TASK__DATASET}}&#x27;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># inherited from task configs</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">BQ_PROJECT</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;{{.TASK__PROJECT}}&#x27;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">BQ_TABLE</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;{{.TASK__TABLE}}&#x27;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">FILTER_EXPRESSION</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;event_timestamp &gt;= &quot;{{.DSTART}}&quot; AND event_timestamp &lt; &quot;{{.DEND}}&quot;&#x27;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">KAFKA_TOPIC</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> optimus_example</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">hello_table</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">PRODUCER_CONFIG_BOOTSTRAP_SERVERS</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;{{.GLOBAL__TRANSPORTER_KAFKA_BROKERS}}&#x27;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">PROTO_SCHEMA</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> example.data.HelloTable</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">STENCIL_URL</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;{{.GLOBAL__TRANSPORTER_KAFKA_BROKERS}}&#x27;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># will be defined as global config</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Some configuration would be auto-generated by Optimus.
You can now commit and push the changes in Job specification.</p><p>There are standards that we want users to maintain but havenâ€™t enforced:</p><ol><li>Single table to topic mapping to be maintained &amp; following a naming convention
helps in better discoverability. Topic names are auto populated with the same naming convention.</li><li>Kafka Brokers are not modifiable &amp; pre-selected per every entity.</li><li>All Protos &amp; Stencil are managed &amp; doesnâ€™t need any user intervention.</li></ol><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="bigquery-and-protobuf-data-type-mapping"></a>Bigquery and Protobuf Data Type Mapping<a class="hash-link" href="#bigquery-and-protobuf-data-type-mapping" title="Direct link to heading">#</a></h3><table><thead><tr><th>Bigquery Type</th><th>Protobuf Type</th></tr></thead><tbody><tr><td>STRING</td><td>string</td></tr><tr><td>BYTES</td><td>bytes</td></tr><tr><td>INTEGER</td><td>int64</td></tr><tr><td>FLOAT</td><td>float</td></tr><tr><td>BOOLEAN</td><td>bool</td></tr><tr><td>TIMESTAMP</td><td>google.protobuf.Timestamp</td></tr><tr><td>DATE</td><td>string</td></tr><tr><td>TIME</td><td>string</td></tr><tr><td>DATETIME</td><td>string</td></tr><tr><td>NUMERIC</td><td>float</td></tr><tr><td>GEOGRAPHY</td><td>string</td></tr></tbody></table></div><footer class="row docusaurus-mt-lg"><div class="col"><a href="https://github.com/odpf/optimus/edit/master/docs/docs/guides/publishing-from-bigquery-to-kafka.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_3DPF">Last updated on <b><time datetime="2021-09-23T09:42:16.000Z">9/23/2021</time></b> by <b>Kush</b></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#config" class="table-of-contents__link">Config:</a></li><li><a href="#bigquery-and-protobuf-data-type-mapping" class="table-of-contents__link">Bigquery and Protobuf Data Type Mapping</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/optimus/">Documentation</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://join.slack.com/t/odpf-community/shared_invite/zt-qfokfy4j-30K9IzigF9Lsqpmt1Jen7Q" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Slack<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/odpf/optimus" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2020-2021 ODPF</div></div></div></footer></div>
<script src="/optimus/assets/js/runtime~main.310a3fda.js"></script>
<script src="/optimus/assets/js/main.7ea66b74.js"></script>
</body>
</html>